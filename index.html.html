<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMGT LOGISTICS PRO v6.3 (ONLINE)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #1e293b; --accent: #10b981; --warning: #f59e0b; --danger: #ef4444; --bg: #f1f5f9; --text: #334155; --edit: #0ea5e9; --dark: #334155; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        /* Login Overlay */
        #login-overlay { position: fixed; inset: 0; background: var(--primary); z-index: 9999; display: flex; align-items: center; justify-content: center; color: white; }
        .login-box { background: white; padding: 30px; border-radius: 15px; color: var(--text); text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 300px; }
        
        .container { max-width: 1600px; margin: auto; display: none; } /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô Login */
        .header-panel { background: var(--primary); padding: 20px 30px; border-radius: 15px; color: white; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .action-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; }
        
        .btn { padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-family: 'Sarabun'; transition: 0.2s; font-size: 14px; }
        .btn-upload { background: var(--accent); color: white; }
        .btn-dark { background: var(--dark); color: white; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 12px; border-top: 4px solid var(--accent); text-align: center; cursor: pointer; }
        
        .table-container { background: white; border-radius: 12px; overflow: auto; max-height: 600px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: #f8fafc; padding: 15px; text-align: left; position: sticky; top: 0; }
        td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; }
        
        .row-released { background-color: #f0fdf4 !important; }
        input[type="text"], input[type="password"] { padding: 10px; border-radius: 8px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2>TMGT LOGIN</h2>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
        <input type="password" id="pass-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô...">
        <button class="btn btn-upload" style="width:100%; margin-top:15px;" onclick="checkLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <p id="login-err" style="color:red; font-size:12px; margin-top:10px; display:none;">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!</p>
    </div>
</div>

<div class="container" id="main-app">
    <div class="header-panel">
        <div>
            <h1 style="margin:0; font-size: 20px;">TMGT LOGISTICS ONLINE</h1>
            <small id="sync-status">üü¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (GitHub)</small>
        </div>
        <input type="date" id="dateFilter" onchange="loadData()" style="padding:8px; border-radius:8px; border:none;">
    </div>

    <div class="action-bar">
        <input type="file" id="excel-files" style="display:none" multiple>
        <button class="btn btn-upload" onclick="document.getElementById('excel-files').click()">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå (A5+)</button>
        <button class="btn btn-dark" onclick="resetFilter()">üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <input type="text" id="searchInput" onkeyup="renderTable()" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô, Job, ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..." style="flex:1;">
    </div>

    <div class="stats-grid">
        <div class="stat-card" onclick="resetFilter()"><span>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span><div id="st-total" style="font-size:22px; font-weight:700;">0</div></div>
        <div class="stat-card" style="border-top-color: var(--warning)" onclick="setFilter('Pending')"><span>‡∏£‡∏≠‡∏õ‡∏•‡πà‡∏≠‡∏¢</span><div id="st-pending" style="font-size:22px; font-weight:700;">0</div></div>
        <div class="stat-card" style="border-top-color: var(--accent)" onclick="setFilter('Released')"><span>‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span><div id="st-done" style="font-size:22px; font-weight:700;">0</div></div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th><th>Job No.</th><th>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏•‡πà‡∏≠‡∏¢</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<script>
    // üîó ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxM_QhdnhFP_p2F69F_j17kJV6jzxRyN2BCOxyIlBUJ4jhcKmFUGwqHyG-AEQnf6Hev/exec";
    const APP_PASS = "1234"; // üîë ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ

    let db, currentData = [], currentFilter = 'All';
    const STORE = 'LogisticsData';

    // ‡πÄ‡∏ä‡πá‡∏Ñ Login
    function checkLogin() {
        const pass = document.getElementById('pass-input').value;
        if(pass === APP_PASS) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            initDB();
        } else {
            document.getElementById('login-err').style.display = 'block';
        }
    }

    // ‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
    function initDB() {
        const req = indexedDB.open('TMGT_DB', 1);
        req.onupgradeneeded = (e) => e.target.result.createObjectStore(STORE, { keyPath: 'id' });
        req.onsuccess = (e) => { db = e.target.result; loadData(); };
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    function loadData() {
        const date = document.getElementById('dateFilter').value || new Date().toISOString().split('T')[0];
        document.getElementById('dateFilter').value = date;
        const tx = db.transaction(STORE, 'readonly');
        tx.objectStore(STORE).getAll().onsuccess = (e) => {
            currentData = e.target.result.filter(item => item.uDate === date).sort((a,b) => b.timestamp - a.timestamp);
            renderTable();
        };
    }

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
    async function sync(items) {
        document.getElementById('sync-status').innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
        try {
            await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "saveAll", items: items }) });
            document.getElementById('sync-status').innerText = "üü¢ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
        } catch (e) { document.getElementById('sync-status').innerText = "üî¥ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"; }
    }

    // ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå A5+
    document.getElementById('excel-files').addEventListener('change', async function(e) {
        const date = document.getElementById('dateFilter').value;
        const time = new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
        let items = [];

        for (let file of e.target.files) {
            const buf = await file.arrayBuffer();
            const wb = XLSX.read(buf, {type: 'array'});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});

            const tx = db.transaction(STORE, 'readwrite');
            for (let i = 4; i < rows.length; i++) {
                if (rows[i][13]) {
                    const item = {
                        id: rows[i][1] + "_" + Date.now() + i,
                        timestamp: Date.now() + i,
                        uTime: time, uDate: date,
                        job: rows[i][1] || "-", truck: rows[i][13].toString(),
                        trailer: rows[i][15] || "-", customer: rows[i][6] || "-",
                        gateOut: "-", status: "Pending"
                    };
                    tx.objectStore(STORE).put(item);
                    items.push(item);
                }
            }
            tx.oncomplete = () => { sync(items); loadData(); };
        }
    });

    function renderTable() {
        const tbody = document.getElementById('table-body');
        const search = document.getElementById('searchInput').value.toLowerCase();
        tbody.innerHTML = '';

        let filtered = currentData.filter(d => (d.truck + d.job + d.customer).toLowerCase().includes(search));
        if(currentFilter === 'Released') filtered = filtered.filter(d => d.status === 'Released');
        if(currentFilter === 'Pending') filtered = filtered.filter(d => d.status === 'Pending');

        filtered.forEach(d => {
            const tr = document.createElement('tr');
            if(d.status === 'Released') tr.className = 'row-released';
            tr.innerHTML = `
                <td>${d.uTime}</td><td>${d.job}</td><td><b>${d.truck}</b></td>
                <td>${d.customer}</td><td style="color:var(--accent); font-weight:bold;">${d.gateOut}</td>
                <td>${d.status}</td>
                <td><button class="btn btn-upload" onclick="release('${d.id}')">üöö ‡∏õ‡∏•‡πà‡∏≠‡∏¢</button></td>`;
            tbody.appendChild(tr);
        });
        document.getElementById('st-total').innerText = currentData.length;
        document.getElementById('st-done').innerText = currentData.filter(x => x.status === 'Released').length;
        document.getElementById('st-pending').innerText = currentData.length - currentData.filter(x => x.status === 'Released').length;
    }

    function release(id) {
        const tx = db.transaction(STORE, 'readwrite');
        const store = tx.objectStore(STORE);
        store.get(id).onsuccess = (e) => {
            const d = e.target.result;
            d.status = 'Released';
            d.gateOut = new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
            store.put(d);
            tx.oncomplete = () => { sync([d]); loadData(); };
        };
    }

    function setFilter(f) { currentFilter = f; renderTable(); }
    function resetFilter() { currentFilter = 'All'; renderTable(); }
</script>
</body>
</html>
